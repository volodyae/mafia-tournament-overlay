<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–≤–µ—Ä–ª–µ–π –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –ú–∞—Ñ–∏–∏ - –ü—Ä–æ—Ç–æ—Ç–∏–ø</title>
    <style>
        :root {
            --red-team-solid: #EF4444;
            --black-team-solid: #1F2937;
            --yellow-team-solid: #FACC15;
            --text-primary: #FFFFFF;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --overlay-scale: 1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Oswald', -apple-system, sans-serif;
            background: transparent;
            overflow: hidden;
            color: var(--text-primary);
        }

        .overlay-container {
            width: 1920px;
            height: 1080px;
            position: relative;
            transform-origin: top left;
        }

        /* –ù–∏–∂–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ */
        .overlay-background-gradient {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 45%;
            background: linear-gradient(
                to top,
                rgba(0, 0, 0, 0.98) 0%,
                rgba(0, 0, 0, 0.8) 25%,
                rgba(0, 0, 0, 0.0) 60%
            );
            z-index: 0;
            pointer-events: none;
        }

        /* –í–∏–Ω—å–µ—Ç–∫–∞ (–Ω–∞ –≤–µ—Å—å –∫–∞–¥—Ä, –Ω–∏–∑ –æ–±—Ä–µ–∑–∞–µ–º –º–∞—Å–∫–æ–π) */
        .overlay-vignette {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height: 100%;
            background: radial-gradient(
                ellipse at center,
                rgba(0, 0, 0, 0.0) 0%,
                rgba(0, 0, 0, 0.0) 70%,
                rgba(0, 0, 0, 0.5) 85%,
                rgba(0, 0, 0, 0.8) 100%
            );
            background-position: center center;
            z-index: 0;
            pointer-events: none;
            -webkit-mask-image: linear-gradient(
                to bottom,
                rgba(0, 0, 0, 1) 0%,
                rgba(0, 0, 0, 1) 55%,
                rgba(0, 0, 0, 0) 75%,
                rgba(0, 0, 0, 0) 100%
            );
            mask-image: linear-gradient(
                to bottom,
                rgba(0, 0, 0, 1) 0%,
                rgba(0, 0, 0, 1) 55%,
                rgba(0, 0, 0, 0) 75%,
                rgba(0, 0, 0, 0) 100%
            );
        }

        .info-block-left,
        .info-block-right,
        .bottom-panel {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .overlay-container.visible .info-block-left,
        .overlay-container.visible .info-block-right,
        .overlay-container.visible .bottom-panel {
            opacity: 1;
            transform: translate(0, 0);
        }

        .overlay-container.hidden .info-block-left {
            opacity: 0;
            transform: translateX(-120%);
        }

        .overlay-container.hidden .info-block-right {
            opacity: 0;
            transform: translateX(120%);
        }

        .overlay-container.hidden .bottom-panel {
            opacity: 0;
            transform: translateY(120%);
        }

        .info-block-left {
            position: absolute;
            top: 10px;
            left: 20px;
            background: transparent;
            padding: 16px;
            min-width: 320px;
            z-index: 1;
        }

        .top-info-row {
            display: flex;
            gap: 120px;
            margin-bottom: 11px;
        }

        .best-move {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100px;
            flex-shrink: 0;
        }

        .best-move-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .best-move-players {
            display: flex;
            gap: 11px;
            align-items: center;
        }

        .best-move-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .best-move-number-wrapper,
        .nominee-number-wrapper,
        .round-number-wrapper {
            position: relative;
            width: 22px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            overflow: hidden;
            box-sizing: border-box;
        }

        .best-move-bg,
        .nominee-bg,
        .round-bg {
            position: absolute;
            inset: 0;
        }

        .best-move-bg.team-red,
        .nominee-bg.team-red,
        .round-bg.team-red {
            background: var(--red-team-solid);
        }

        .best-move-bg.team-black,
        .nominee-bg.team-black,
        .round-bg.team-black {
            background: var(--black-team-solid);
        }

        .round-bg.neutral {
            background: transparent;
        }

        .best-move-gradient,
        .nominee-gradient,
        .round-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top,
                rgba(0,0,0,0.55) 0%,
                rgba(0,0,0,0.0) 100%);
        }

        .best-move-number,
        .nominee-number,
        .round-number {
            position: relative;
            z-index: 2;
            font-size: 17px;
            font-weight: 700;
            padding: 1px 8px 0 8px;
            color: #fff;
            transform: translateY(-2px);
        }

        .round-number.cross {
            font-size: 11px;
        }

        .nominees {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nominees-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .nominees-list {
            display: flex;
            gap: 11px;
            align-items: center;
        }

        .nominee-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .rounds-table {
            border-collapse: collapse;
            table-layout: fixed;
            width: auto;
        }

        .rounds-table th {
            padding: 2px 0;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0.6;
            width: 32px;
        }

        .rounds-table th:first-child {
            width: 28px;
            padding-right: 8px;
        }

        .rounds-table td {
            padding: 3px 0;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            width: 32px;
            vertical-align: middle;
            height: 30px;
        }

        .rounds-table td:first-child {
            width: 28px;
            padding-right: 8px;
        }

        .rounds-table .action-icon {
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .round-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 2px;
        }

        .round-multi {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }

        /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è multi-voted —Å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π –ø–æ–¥–ª–æ–∂–∫–æ–π */
        .voted-multi-container {
            position: relative;
            width: 22px;
            height: 28px;
            border-radius: 4px;
            overflow: hidden;
        }

        .voted-multi-bg {
            position: absolute;
            inset: 0;
        }

        .voted-multi-bg.neutral {
            background: transparent;
        }

        .voted-multi-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top,
                rgba(0,0,0,0.55) 0%,
                rgba(0,0,0,0.0) 100%);
        }

        .voted-multi-content {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .voted-multi-inner {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .voted-small-number {
            position: absolute;
            z-index: 2;
            font-size: 10px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .voted-two-top {
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
        }

        .voted-two-bottom {
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
        }

        .voted-three-top {
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
        }

        .voted-three-bottom-left {
            bottom: 3px;
            left: 4px;
        }

        .voted-three-bottom-right {
            bottom: 3px;
            right: 4px;
        }

        .voted-four-top-left {
            top: 3px;
            left: 4px;
        }

        .voted-four-top-right {
            top: 3px;
            right: 4px;
        }

        .voted-four-bottom-left {
            bottom: 3px;
            left: 4px;
        }

        .voted-four-bottom-right {
            bottom: 3px;
            right: 4px;
        }

        .info-block-right {
            position: absolute;
            top: 10px;
            right: 20px;
            background: transparent;
            padding: 16px;
            text-align: center;
            z-index: 1;
        }

        .series-info {
            margin-bottom: 4px;
        }

        .series-name {
            font-size: 36px;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0.7;
            text-transform: uppercase;
        }

        .game-info {
            font-size: 30px;
            font-weight: 600;
            text-align: right;
            opacity: 0.7;
            margin-top: -2px;
            color: var(--text-primary);
        }

        .game-current {
            color: var(--text-primary);
            font-size: 30px;
            font-weight: 600;
        }

        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            gap: 8px;
            z-index: 1;
        }

        .player-card {
            width: calc((100% - 9 * 8px) / 10);
            position: relative;
            border-radius: 12px;
            overflow: visible;
            background: transparent;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
        }

        .player-card-inner {
            position: relative;
            width: 100%;
        }

        .player-card.eliminated {
            transform: translateY(20px);
            opacity: 0.5;
        }

        .player-card.just-eliminated {
            animation: eliminate 0.5s ease-out forwards;
        }

        .role-badge {
            position: absolute;
            top: -12px;
            right: 0px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 23px;
            font-weight: 700;
            width: 35px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid rgba(255, 255, 255, 0.3);
            line-height: 1;
            padding-top: 0;
            padding-bottom: 3px;
        }

        .role-badge-sheriff {
            background: var(--yellow-team-solid);
            border-color: var(--yellow-team-solid);
            color: #111827;
        }

        .elimination-icon {
            position: absolute;
            top: -12px;
            left: 0px;
            background: none;
            border: none;
            width: auto;
            height: auto;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
        }

        .player-media {
            width: 100%;
            aspect-ratio: 3 / 3.2;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            background: transparent;
            position: relative;
        }

        .player-portrait {
            width: 100%;
            height: 125%;
            object-fit: cover;
            object-position: center top;
            background-color: transparent;
            image-rendering: smooth;
            image-rendering: high-quality;
            image-rendering: auto;
            position: relative;
            z-index: 2;
        }

        .player-placeholder {
            width: 100%;
            height: 125%;
            background: linear-gradient(135deg, #374151 0%, #1F2937 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #6B7280;
            position: relative;
            z-index: 2;
        }

        .player-role-strip {
            width: 100%;
            height: 32px;
            position: relative;
            overflow: hidden;
        }

        .player-role-strip-inner {
            width: 100%;
            height: 100%;
        }

        .player-role-strip-inner.red {
            background: var(--red-team-solid);
        }

        .player-role-strip-inner.black {
            background: var(--black-team-solid);
        }

        .player-role-strip-inner.sheriff-strip {
            background: var(--yellow-team-solid);
        }

        .player-role-gradient {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 72px;
            pointer-events: none;
            mix-blend-mode: multiply;
            z-index: 1;
        }

        .player-role-gradient.red {
            background: linear-gradient(to top, rgba(239, 68, 68, 0.95) 0%, rgba(239, 68, 68, 0.0) 100%);
        }

        .player-role-gradient.black {
            background: linear-gradient(to top, rgba(17, 24, 39, 0.95) 0%, rgba(17, 24, 39, 0.0) 100%);
        }

        .player-role-gradient.sheriff-strip {
            background: linear-gradient(to top, rgba(250, 204, 21, 0.7) 0%, rgba(250, 204, 21, 0.0) 100%);
        }

        .player-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            pointer-events: none;
        }

        .player-info-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0.4) 100%);
        }

        .player-info-content {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            transform: translateY(-2px);
        }

        .player-number {
            font-size: 19px;
            font-weight: 700;
            width: 30px;
            flex-shrink: 0;
            text-align: left;
        }

        .player-nickname {
            font-size: 19px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .player-nickname-text {
            flex: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tournament-logo {
            width: 100px;
            height: 100px;
            margin-right: 12px;
            display: none;
        }

        .tournament-logo.visible {
            display: block;
        }

        .tournament-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* –ò–∫–æ–Ω–∫–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π (SVG –∫–∞–∫ background-image) */
        .icon {
            display: inline-block;
            width: 34px;
            height: 34px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        .rounds-table .icon {
            width: 26px;
            height: 26px;
        }

        .rounds-table .icon-none {
            width: 16px;
            height: 16px;
        }

        .icon-kill {
            background-image: url('./icons/kill.svg');
        }

        .icon-don-check {
            background-image: url('./icons/don-check.svg');
        }

        .icon-sheriff-check {
            background-image: url('./icons/sheriff-check.svg');
        }

        .icon-voted {
            background-image: url('./icons/voted.svg');
        }

        .icon-none {
            background-image: url('./icons/none.svg');
        }

        .icon-removed {
            background-image: url('./icons/removed.svg');
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes eliminate {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(20px);
                opacity: 0.5;
            }
        }

        @keyframes entryFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .entry-anim {
            animation: entryFade 0.25s.ease-out;
        }

        .animate-in {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes role-change-flash {
            0% {
                transform: translateY(0) scale(1);
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.0);
            }
            30% {
                transform: translateY(-6px) scale(1.04);
                box-shadow: 0 0 18px 4px rgba(250, 204, 21, 0.45);
            }
            70% {
                transform: translateY(-2px) scale(1.02);
                box-shadow: 0 0 10px 2px rgba(250, 204, 21, 0.2);
            }
            100% {
                transform: translateY(0) scale(1);
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.0);
            }
        }

        .player-card.role-changed {
            animation: role-change-flash 0.5s.ease-out;
        }
    </style>
</head>
<body>
    <div class="overlay-container visible">
        <div class="overlay-background-gradient"></div>
        <div class="overlay-vignette"></div>

        <div class="info-block-left animate-in">
            <div class="top-info-row">
                <div class="best-move">
                    <div class="best-move-title">–õ–•:</div>
                    <div class="best-move-players"></div>
                </div>

                <div class="nominees">
                    <div class="nominees-title">–í—ã—Å—Ç–∞–≤–ª–µ–Ω—ã:</div>
                    <div class="nominees-list"></div>
                </div>
            </div>

            <table class="rounds-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="info-block-right animate-in">
            <div class="series-info">
                <div class="series-name">–°–ï–†–ò–Ø</div>
            </div>
            <div class="game-info">
                –ò–ì–†–ê <span class="game-current">1</span>/5
            </div>
        </div>

        <div class="bottom-panel"></div>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');

        if (!gameId) {
            document.body.innerHTML = '<div style="color: white; text-align: center; padding: 50px; font-size: 24px;">‚ùå Game ID not found</div>';
        }

        let gameData = null;
        let socket = null;
        let previousEliminated = new Set();
        let prevBestMoveIds = [];
        let prevNomineeIds = [];
        let prevRoundsKey = '';

        function scaleOverlay() {
            const container = document.querySelector('.overlay-container');
            if (!container) return;

            const baseWidth = 1920;
            const baseHeight = 1080;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const scaleX = screenWidth / baseWidth;
            const scaleY = screenHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY);

            container.style.setProperty('--overlay-scale', scale);

            const scaledWidth = baseWidth * scale;
            const scaledHeight = baseHeight * scale;
            const offsetX = (screenWidth - scaledWidth) / 2;
            const offsetY = (screenHeight - scaledHeight) / 2;

            container.style.left = `${offsetX}px`;
            container.style.top = `${offsetY}px`;
            container.style.transform = `scale(${scale})`;
        }

        function applyOverlayVisibility() {
            const container = document.querySelector('.overlay-container');
            if (!container || !gameData) return;

            if (gameData.overlay_hidden) {
                container.classList.add('hidden');
                container.classList.remove('visible');
            } else {
                container.classList.remove('hidden');
                container.classList.add('visible');
            }
        }

        async function loadGameData() {
            try {
                const response = await fetch(`http://localhost:3000/api/games/${gameId}`);
                const newData = await response.json();

                gameData = newData;
                renderOverlay();
                applyOverlayVisibility();
            } catch (error) {
                console.error('Error loading game data:', error);
            }
        }

        function getEliminationInfo(playerId) {
            if (!gameData || !gameData.rounds) {
                return { eliminated: false, reason: null };
            }

            let eliminated = false;
            let reason = null;
            let earliestRound = Infinity;

            for (const round of gameData.rounds) {
                if (!round) continue;
                const rn = round.round_number || 0;

                if (!round.mafia_miss && round.mafia_kill_player_id === playerId && rn < earliestRound) {
                    earliestRound = rn;
                    eliminated = true;
                    reason = 'killed';
                }

                if (
                    !round.nobody_voted_out &&
                    Array.isArray(round.voted_out_players) &&
                    round.voted_out_players.includes(playerId) &&
                    rn < earliestRound
                ) {
                    earliestRound = rn;
                    eliminated = true;
                    reason = 'voted';
                }
            }

            // —Å—Ç–∞—Ç—É—Å "removed" —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø—Ä—è–º–æ –≤ seating
            const seat = gameData.seating.find(s => s.player_id === playerId);
            if (seat && seat.is_eliminated && seat.elimination_reason === 'removed') {
                eliminated = true;
                reason = 'removed';
            }

            return { eliminated, reason };
        }

        function renderOverlay() {
            if (!gameData || !gameData.seating) return;

            document.querySelector('.series-name').textContent =
                gameData.tournament_name || gameData.series_name || '–°–ï–†–ò–Ø';
            document.querySelector('.game-current').textContent = gameData.game_number;

            const bottomPanel = document.querySelector('.bottom-panel');
            const newEliminated = new Set();

            bottomPanel.innerHTML = gameData.seating.map(seat => {
                const { eliminated, reason } = getEliminationInfo(seat.player_id);
                const isEliminated = eliminated;
                if (isEliminated) newEliminated.add(seat.player_id);
                const justEliminated = isEliminated && !previousEliminated.has(seat.player_id);

                const roleLabel = getRoleLabel(seat.role);

                let eliminationIconClass = null;
                if (reason === 'voted') {
                    eliminationIconClass = 'icon-voted';
                } else if (reason === 'killed') {
                    eliminationIconClass = 'icon-kill';
                } else if (reason === 'removed') {
                    eliminationIconClass = 'icon-removed';
                }

                let stripClass = 'red';
                if (seat.role === 'mafia' || seat.role === 'don') stripClass = 'black';
                if (seat.role === 'sheriff') stripClass = 'sheriff-strip';

                return `
                    <div class="player-card ${isEliminated ? 'eliminated' : ''} ${justEliminated ? 'just-eliminated' : ''}"
                         data-position="${seat.position}">
                        <div class="player-card-inner">
                            ${isEliminated && eliminationIconClass
                                ? `<div class="elimination-icon"><span class="icon ${eliminationIconClass}"></span></div>`
                                : ''
                            }
                            ${roleLabel ? `<div class="role-badge ${seat.role === 'sheriff' ? 'role-badge-sheriff' : ''}">${roleLabel}</div>` : ''}

                            <div class="player-media">
                                <div class="player-role-gradient ${stripClass}"></div>
                                ${seat.photo_url 
                                    ? `<img src="${seat.photo_url}" alt="${seat.nickname}" class="player-portrait" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                       <div class="player-placeholder" style="display:none;">üë§</div>`
                                    : `<div class="player-placeholder">üë§</div>`
                                }
                            </div>

                            <div class="player-role-strip">
                                <div class="player-role-strip-inner ${stripClass}"></div>

                                <div class="player-info">
                                    <div class="player-info-gradient"></div>
                                    <div class="player-info-content">
                                        <div class="player-nickname">
                                            <span class="player-number">${seat.position}</span>
                                            <span class="player-nickname-text">${seat.nickname}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            previousEliminated = newEliminated;

            renderBestMove();
            renderNominees();
            renderRounds();
        }

        function renderBestMove() {
            const bm = gameData.best_move;
            const bestMovePlayersDiv = document.querySelector('.best-move-players');

            if (!bm) {
                bestMovePlayersDiv.innerHTML = '';
                prevBestMoveIds = [];
                return;
            }

            const suspects = [bm.suspect_1, bm.suspect_2, bm.suspect_3].filter(Boolean);
            const newIds = suspects.slice();

            bestMovePlayersDiv.innerHTML = suspects.map(playerId => {
                const seat = gameData.seating.find(s => s.player_id === playerId);
                if (!seat) return '';
                const teamClass = seat.team === 'red' ? 'team-red' : 'team-black';

                const isNew = !prevBestMoveIds.includes(playerId);

                return `
                    <div class="best-move-player ${isNew ? 'entry-anim' : ''}">
                        <div class="best-move-number-wrapper">
                            <div class="best-move-bg ${teamClass}"></div>
                            <div class="best-move-gradient"></div>
                            <div class="best-move-number">${seat.position}</div>
                        </div>
                    </div>
                `;
            }).join('');

            prevBestMoveIds = newIds;
        }

        function renderNominees() {
            const nomineesList = document.querySelector('.nominees-list');
            if (!gameData.nominees || gameData.nominees.length === 0) {
                nomineesList.innerHTML = '';
                prevNomineeIds = [];
                return;
            }

            const newIds = gameData.nominees.map(n => n.player_id);

            nomineesList.innerHTML = gameData.nominees.map(nominee => {
                const seat = gameData.seating.find(s => s.player_id === nominee.player_id);
                if (!seat) return '';
                const teamClass = seat.team === 'red' ? 'team-red' : 'team-black';
                const isNew = !prevNomineeIds.includes(nominee.player_id);

                return `
                    <div class="nominee-item ${isNew ? 'entry-anim' : ''}">
                        <div class="nominee-number-wrapper">
                            <div class="nominee-bg ${teamClass}"></div>
                            <div class="nominee-gradient"></div>
                            <div class="nominee-number">${seat.position}</div>
                        </div>
                    </div>
                `;
            }).join('');

            prevNomineeIds = newIds;
        }

        function renderRounds() {
            const tbody = document.querySelector('.rounds-table tbody');
            const maxRounds = 6;

            const actions = [
                { type: 'kill',    iconClass: 'icon-kill' },
                { type: 'don',     iconClass: 'icon-don-check' },
                { type: 'sheriff', iconClass: 'icon-sheriff-check' },
                { type: 'voted',   iconClass: 'icon-voted' }
            ];

            const roundsKey = JSON.stringify(gameData.rounds || []);
            const isNewState = roundsKey !== prevRoundsKey;
            prevRoundsKey = roundsKey;

            const rows = actions.map(action => {
                let cells = `<td class="action-icon"><span class="icon ${action.iconClass}"></span></td>`;

                for (let col = 1; col <= maxRounds; col++) {
                    const round = (gameData.rounds || []).find(r => r.round_number === col);

                    if (!round) {
                        cells += '<td><div class="round-cell"></div></td>';
                        continue;
                    }

                    let content = '';

                    if (action.type === 'kill') {
                        if (round.mafia_miss) {
                            content = wrapRoundSymbol(null, 'neutral', isNewState, true);
                        } else if (round.mafia_kill_player_id) {
                            const seat = gameData.seating.find(s => s.player_id === round.mafia_kill_player_id);
                            if (seat) {
                                const teamClass = seat.team === 'red' ? 'team-red' : 'team-black';
                                content = wrapRoundNumber(seat.position, teamClass, isNewState);
                            }
                        }
                    } else if (action.type === 'don') {
                        if (round.don_check_player_id) {
                            const seat = gameData.seating.find(s => s.player_id === round.don_check_player_id);
                            if (seat) {
                                const teamClass = seat.team === 'red' ? 'team-red' : 'team-black';
                                content = wrapRoundNumber(seat.position, teamClass, isNewState);
                            }
                        } else {
                            content = wrapRoundSymbol(null, 'neutral', isNewState, true);
                        }
                    } else if (action.type === 'sheriff') {
                        if (round.sheriff_check_player_id) {
                            const seat = gameData.seating.find(s => s.player_id === round.sheriff_check_player_id);
                            if (seat) {
                                const teamClass = seat.team === 'red' ? 'team-red' : 'team-black';
                                content = wrapRoundNumber(seat.position, teamClass, isNewState);
                            }
                        } else {
                            content = wrapRoundSymbol(null, 'neutral', isNewState, true);
                        }
                    } else if (action.type === 'voted') {
                        const votedIds = Array.isArray(round.voted_out_players)
                            ? round.voted_out_players
                            : [];

                        if (round.nobody_voted_out || votedIds.length === 0) {
                            content = wrapRoundSymbol(null, 'neutral', isNewState, true);
                        } else if (votedIds.length === 1) {
                            const id = votedIds[0];
                            const seat = gameData.seating.find(s => s.player_id === id);
                            if (seat) {
                                const teamClass = seat.team === 'red' ? 'team-red' : 'team-black';
                                content = wrapRoundNumber(seat.position, teamClass, isNewState);
                            }
                        } else {
                            content = renderMultiVoted(votedIds, isNewState);
                        }
                    }

                    cells += `<td><div class="round-cell">${content}</div></td>`;
                }

                return `<tr>${cells}</tr>`;
            });

            tbody.innerHTML = rows.join('');
        }

        function wrapRoundNumber(value, teamClass, animate) {
            return `
              <div class="round-number-wrapper ${animate ? 'entry-anim' : ''}">
                <div class="round-bg ${teamClass}"></div>
                <div class="round-gradient"></div>
                <div class="round-number">${value}</div>
              </div>`;
        }

        function wrapRoundSymbol(symbol, bgClass, animate, useIconNone) {
            const inner = useIconNone
                ? `<span class="icon icon-none"></span>`
                : `<span class="round-number ${symbol === '‚ùå' ? 'cross' : ''}">${symbol}</span>`;

            return `
              <div class="round-number-wrapper ${animate ? 'entry-anim' : ''}">
                <div class="round-bg ${bgClass}"></div>
                <div class="round-gradient"></div>
                ${inner}
              </div>`;
        }

        function renderMultiVoted(votedIds, animate) {
            const positions = votedIds
                .map(id => {
                    const seat = gameData.seating.find(s => s.player_id === id);
                    return seat ? seat.position : null;
                })
                .filter(v => v !== null)
                .slice(0, 4);

            const len = positions.length;
            let numbersHtml = '';

            if (len === 2) {
                numbersHtml = `
                    <span class="voted-small-number voted-two-top">${positions[0]}</span>
                    <span class="voted-small-number voted-two-bottom">${positions[1]}</span>
                `;
            } else if (len === 3) {
                numbersHtml = `
                    <span class="voted-small-number voted-three-top">${positions[0]}</span>
                    <span class="voted-small-number voted-three-bottom-left">${positions[1]}</span>
                    <span class="voted-small-number voted-three-bottom-right">${positions[2]}</span>
                `;
            } else if (len >= 4) {
                numbersHtml = `
                    <span class="voted-small-number voted-four-top-left">${positions[0]}</span>
                    <span class="voted-small-number voted-four-top-right">${positions[1]}</span>
                    <span class="voted-small-number voted-four-bottom-left">${positions[2]}</span>
                    <span class="voted-small-number voted-four-bottom-right">${positions[3]}</span>
                `;
            } else {
                numbersHtml = positions.map(p =>
                    `<span class="voted-small-number voted-two-top">${p}</span>`
                ).join('');
            }

            return `
                <div class="voted-multi-container ${animate ? 'entry-anim' : ''}">
                    <div class="voted-multi-bg neutral"></div>
                    <div class="voted-multi-gradient"></div>
                    <div class="voted-multi-content">
                        <div class="voted-multi-inner">
                            ${numbersHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function getRoleLabel(role) {
            const labels = { mafia: '–ú', don: '–î', sheriff: '–®', civilian: '' };
            return labels[role] || '';
        }

        function animateRoleChange(positions) {
            if (!Array.isArray(positions) || positions.length === 0) return;

            requestAnimationFrame(() => {
                positions.forEach(pos => {
                    const card = document.querySelector(`.player-card[data-position="${pos}"]`);
                    if (!card) return;

                    card.classList.remove('role-changed');
                    void card.offsetWidth;
                    card.classList.add('role-changed');

                    setTimeout(() => {
                        card.classList.remove('role-changed');
                    }, 600);
                });
            });
        }

        function connectWebSocket() {
            socket = io('http://localhost:3000');
            socket.on('connect', () => {
                socket.emit('join_game', gameId);
            });
            socket.on('game_updated', () => {
                loadGameData();
            });
            socket.on('roles_changed', payload => {
                if (!payload || payload.gameId !== gameId) return;
                animateRoleChange(payload.positions || []);
            });
        }

        window.addEventListener('load', () => {
            scaleOverlay();
            loadGameData();
            connectWebSocket();
        });

        window.addEventListener('resize', scaleOverlay);
    </script>
</body>
</html>
